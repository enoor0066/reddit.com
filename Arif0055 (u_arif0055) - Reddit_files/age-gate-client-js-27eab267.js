import{t,_ as e,n as i,P as s,x as n,aV as r,be as o,dh as a,T as c,ag as h,G as l,$ as d,e as u,c as g}from"./shell-c6dfa469.js";import{aC as p,aD as f,aE as m}from"./age-gate-standalone-client-js-cd633927.js";import{s as E,x as v}from"./icon-5ce37e54.js";import"./faceplate-form-3f273b3d.js";import"./validate-image-cdf72f61.js";import"./community-onboarding-completed-modal-client-js-ab917ec7.js";import"./filterNullish-48b417d6.js";import"./text-input-6aea591c.js";import"./constants-b1a52852.js";import"./hui-user-drawer-client-js-b156b2df.js";import"./TinyGesture-89d9957c.js";var y,A,b,w;!function(t){t.AgeCollect="age-collect",t.AgeRestrict="age-restrict",t.AgeVerify="age-verify",t.AgeConfirm="age-confirm"}(y||(y={})),function(t){t.UNAVAILABLE_AGE="UNAVAILABLE_AGE",t.UNAVAILABLE_UNVERIFIED_AGE="UNAVAILABLE_UNVERIFIED_AGE",t.UNDER_VERIFIED_AGE="UNDER_VERIFIED_AGE",t.UNVERIFIED_AGE="UNVERIFIED_AGE",t.UNDERAGE="UNDERAGE"}(A||(A={})),function(t){t.BeginVerification="begin-verification"}(b||(b={})),function(t){t.BeginVerification="/svc/shreddit/age-verification/begin-verification"}(w||(w={}));const S="force_age_gating";let V=window.location,B=class extends E{constructor(){super(...arguments),this.page=y.AgeCollect,this.postSubmitBehavior="destination",this.successDestination="reload",this.isSettingsCollection=!1,this.countdown=new p(this),this.pubsub=new s(this),this.onInputKeypress=t=>{"Enter"===t.key&&this.isValid?this.validateAge():isNaN(t.key)&&t.preventDefault()},this.onInput=()=>{this.clearErrorMessage(),this.saveButton.disabled=!this.isValid},this.redirectToAgeVerificationFlow=async()=>{if(this.withAgeVerification){this.submitButton.disabled=!0;try{const t=await fetch(w.BeginVerification,{body:JSON.stringify({completionUrl:this.getAgeVerificationCompletionUrl(),csrf_token:n.get("csrf_token")}),method:"POST"}),{data:e,error:i}=await t.json();if(!t.ok||!e?.continueUrl||i)throw new Error(`Failed to fetch age verification url from ${w.BeginVerification}`);V.href=e.continueUrl}catch(t){this.dispatchError("Something went wrong",r(t)),this.submitButton.disabled=!1;const e=t;window.Sentry?.captureMessage?.(e.message)}}},this.submitAge=async()=>{try{const t=this.getDateString();if(null===t)return;const e=await fetch(o.UpdateBirthdate,{method:"POST",body:JSON.stringify({birthdate:t,csrf_token:n.get("csrf_token")})});if(e.ok){if(this.withAgeVerification){const{collection_status:t}=await e.json();if(t===a.Unverified)return void this.redirectToAgeVerificationFlow()}if("destination"===this.postSubmitBehavior)if("reload"===this.successDestination)this.reloadThePage();else{const t=new URL(this.successDestination);t.origin===V.origin&&(V.href=this.successDestination)}else"close"===this.postSubmitBehavior&&(this.pubsub.publish(c.AgeGateBirthdateSubmitted,{birthdate:t}),await(this.dialogSheet?.hide()),this.disableCollectionPage(),this.page=y.AgeCollect)}else this.dispatchError("Something went wrong",h.FetchBadResponse)}catch(t){this.dispatchError("Something went wrong",r(t))}},this.validateAge=()=>{const t=this.getDateString();null===t?(this.saveButton.disabled=!0,this.setErrorMessage("Invalid birthdate")):(this.agePlaceholder.date=f(t),this.page=y.AgeConfirm)},this.dispatchError=(t,e,i=l.error)=>{const s=g("faceplate-alert",{level:i,message:t});this.dispatchEvent(s)},this.updateCountdown=()=>{this.countdownText.textContent=this.countdown.secondsRemaining},this.cancelAndClose=()=>{this.page=y.AgeCollect,this.dialogSheet?.hide()},this.cancelAndRedirect=()=>{this.page=y.AgeRestrict,this.countdown.start(8e3),this.redirectTimeout=setTimeout(this.goHome,8e3)}}get dialogSheet(){return document.querySelector("#age-gate-interstitial")}get inputs(){return[this.querySelector('faceplate-text-input[name="year"]'),this.querySelector('faceplate-text-input[name="month"]'),this.querySelector('faceplate-text-input[name="day"]')].filter(Boolean)}get form(){return this.querySelector("faceplate-form")}get saveButton(){return this.querySelector("#age-gate-submit-btn")}get submitButton(){return this.querySelector(`[slot="${this.page}"] button[slot="primary-button"]`)}get isValid(){return Array.from(this.inputs).every((t=>t.value.length>0&&t.value.length<=(t.maxLength||4)))}get countdownText(){return this.querySelector("#age-restricted-countdown")}get agePlaceholder(){return this.querySelector("#age-date-placeholder")}connectedCallback(){super.connectedCallback(),this.addEventListener("input",this.onInput),this.addEventListener("change",this.onInput),this.inputs?.forEach((t=>t.addEventListener("keypress",this.onInputKeypress))),this.page===y.AgeRestrict&&this.cancelAndRedirect()}disconnectedCallback(){super.disconnectedCallback(),this.removeEventListener("input",this.onInput),this.removeEventListener("change",this.onInput),this.inputs?.forEach((t=>t.removeEventListener("keypress",this.onInputKeypress))),clearTimeout(this.redirectTimeout)}updated(t){super.updated(t),this.countdown.active&&this.updateCountdown()}getAgeVerificationCompletionUrl(){let t=V.origin;t.includes("old.reddit.com")&&(t=t.replace("old.reddit.com","www.reddit.com"));const e=new URL(`${t}/partner/persona/return`),i="reload"===this.successDestination?V.href:this.successDestination,s=new URL(i);s.searchParams.delete(S),e.searchParams.set("destination",s.toString());const n=d();return n&&e.searchParams.set("page-type",n),e.searchParams.set("variant","age-verification"),e.toString()}disableCollectionPage(){this.inputs.forEach((t=>{t.disabled=!0})),this.saveButton&&(this.saveButton.disabled=!0)}reloadThePage(){const t=new URL(V.href);t.searchParams.delete(S),t.href===V.href?V.reload():V.href=t.href}goHome(){V.href="/"}getDateString(){const[t,e,i]=Array.from(this.inputs).map((t=>parseInt(t?.value??"",10)));if(!i||!e||!t)return null;const s=new Date(t,e,0).getDate(),n=(new Date).getFullYear();return i<0||i>s||e<1||e>12||t<n-120||t>n-5?null:`${t}-${m(e)}-${m(i)}`}setErrorMessage(t){const e=this.form;this.inputs.forEach(((i,s)=>{e?.invalidateFieldWithMessage(i.name,0===s?t:" ")}))}clearErrorMessage(){const t=this.form;this.inputs.forEach((e=>{e.checkValidity()||t?.invalidateFieldWithMessage(e.name,"")}))}render(){return v`<slot name="${this.page}"></slot>`}};B.styles=[t],e([i({type:Boolean,attribute:"with-age-verification"})],B.prototype,"withAgeVerification",void 0),e([i({type:String,reflect:!0})],B.prototype,"page",void 0),e([i({type:String,attribute:"post-submit-behavior"})],B.prototype,"postSubmitBehavior",void 0),e([i({type:String,attribute:"post-success-destination"})],B.prototype,"successDestination",void 0),e([i({type:Boolean,attribute:"is-settings-collection"})],B.prototype,"isSettingsCollection",void 0),B=e([u("age-gate-dialog")],B);

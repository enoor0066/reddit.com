import{O as t,J as e,t as s,_ as i,n as r,g as o,c as a,G as n,u as l,e as d,e_ as h}from"./shell-c6dfa469.js";import{R as c,S as p,a as u}from"./helpers-90efd9f3.js";import"./chat-mobile-xpromo-client-js-34b8f6a1.js";import"./app-selector-client-js-1b454bf5.js";import{a as m}from"./promote-post-actions-controller-df3244ab.js";import{s as g,x as f,a as b,B as y}from"./icon-5ce37e54.js";import"./faceplate-radio-input-43a5808f.js";import"./validate-image-cdf72f61.js";import"./shreddit-slotter-3507e9e2.js";import{c as v}from"./zendesk-step-helper-a4df236d.js";import"./render-saved-response-template-by-subreddit-id-69204cc7.js";import"./faceplate-textarea-input-fdd1f435.js";import"./index-be299d4e.js";import"./index-6053883b.js";import"./constants-b1a52852.js";import"./filterNullish-48b417d6.js";import"./age-gate-standalone-client-js-cd633927.js";import"./TinyGesture-89d9957c.js";import"./utils-69251401.js";import"./text-input-6aea591c.js";var L,S;!function(t){t.isSubmitError="isSubmitError",t.isRateLimitError="isRateLimitError",t.isBlockingError="isBlockingError",t.isReportBlockingSuccess="isReportBlockingSuccess",t.isReportUnblockingSuccess="isReportUnblockingSuccess"}(L||(L={})),function(t){t.Post="post",t.Comment="comment",t.User="user",t.PrivateMessage="private_message"}(S||(S={}));class C{constructor(s){this.gqlOperationByType={[S.Post]:t.ReportPost,[S.Comment]:t.ReportComment,[S.User]:t.ReportUserDetails,[S.PrivateMessage]:t.ReportPrivateMessage},this.inputKeyByType={[S.Post]:"postId",[S.Comment]:"commentId",[S.User]:"redditorId",[S.PrivateMessage]:"messageId"},this.getItemType=t=>{if(t.includes("t4_"))return S.PrivateMessage;if(t.includes("t3_"))return S.Post;if(t.includes("t2_"))return S.User;if(t.includes("t1_"))return S.Comment;throw new Error("Unsupported item type provided")},this.onReportSubmit=async t=>{const{actionData:e,hiddenInputValues:s}=t;if(!e)return;const i=s.thingId,r=this.getItemType(i),o=this.reportPayloadGenerator(s,e),a=await this.getReportOperationResponse(r,i,o);if(!a||a.errors&&a.errors.length)return!1;const n="reportPost"in a.data&&a.data?.reportPost?.ok,l="reportComment"in a.data&&a.data?.reportComment?.ok,d="reportUserDetails"in a.data&&a.data?.reportUserDetails?.ok,h="reportPrivateMessage"in a.data&&a.data?.reportPrivateMessage?.ok;return n||l||d||h},this.onCTLReportSubmit=async(t,e)=>{const s=this.getItemType(t),i=await this.getReportOperationResponse(s,t,{fromHelpDesk:!1,siteRule:"SELF_HARM",...e?{userDetailType:e}:{}});if(!i||i.errors&&i.errors.length)return!1;const r="reportPost"in i.data&&i.data?.reportPost?.ok,o="reportComment"in i.data&&i.data?.reportComment?.ok,a="reportUserDetails"in i.data&&i.data?.reportUserDetails?.ok;return!!(r||o||a)||null},this.reportPayloadGenerator=(t,e)=>{const{ruleType:s,ruleId:i,freeText:r,additionalContent:o}=e,a=t[i.ref],n=this.getItemType(t.thingId),l={fromHelpDesk:!1,...this.isEmbed?{hostAppName:"R2"}:{}};if("site"===s?l.siteRule=a:"subreddit"===s&&"other"===a?l.customRule=t["customRule.value"]:l.subredditRule=t["subredditRule.value"],n===S.User&&(l.userDetailType=t["userDetail.value"]),r&&r.ref&&(l.freeText=t["freeText.value"]),o&&o.ref){const e=t[o.ref];e&&(l.reportedItems=e.split(",").map((t=>({itemId:t}))))}return l},this.getReportOperationResponse=async(t,e,s)=>{const i=this.inputKeyByType[t];if(!i)throw new Error("Unsupported item type provided");const r={[i]:e,...s};return await this.reportRequest(t,r)},this.reportRequest=async(t,s)=>{const i=this.gqlOperationByType[t];if(!i)throw new Error("Unsupported item type provided");try{return await e({operation:i,variables:{input:s}})}catch(t){return}},this.isEmbed=s}}let E=class extends g{constructor(){super(...arguments),this.isEmbed=!1,this.permalink="",this.countryCode="",this.buttonText="Next",this.isDisabled=!0,this.href="",this.onButtonClick=t=>{t.stopImmediatePropagation();const e=this.config.action,s=e?this.helpers?.getAction(e):null;if(e&&s){const t=this.helpers?.performAction(s);if("screenId"===t?.key){const e=a("shreddit-slotter-set-slot-name",{slotName:t.value}),s=this.helpers?.getHiddenInputValue("screenSequence"),i=s.split(" ");i.push(t.value),this.helpers?.setHiddenInputValue("screenSequence",i.toString()),this.getRootNode().host.dispatchEvent(e)}else t?.formSubmit?(this.dispatchEvent(a("submit-report-modal")),this.handleSubmission(t.data)):t?.href?("DSA"===this.helpers?.getHiddenInputValue("categoryOrRule.value")&&this.countryCode?window.open(v("https://support.reddithelp.com/hc/requests/new?ticket_form_id=19623931614484",this.countryCode,this.permalink)):window.open(t.href),this.dispatchEvent(a("close-report-modal",{buttonAction:e.actionType}))):t?.formClose?this.dispatchEvent(a("close-report-modal",{buttonAction:e.actionType})):t?.openCtlFlow&&this.dispatchEvent(a("open-ctl-modal"))}},this.toggleLoadingIndicator=()=>{const t=this.shadowRoot?.querySelector("faceplate-progress"),e=this.shadowRoot?.querySelector("span.report-button-content");t?.classList.toggle("hidden"),e?.classList.toggle("opacity-0")},this.handleSubmission=async t=>{this.toggleLoadingIndicator();const e=this.helpers?.getAllHiddenInputValues();if(t&&e){await(this.gqlHelpers?.onReportSubmit({actionData:t,hiddenInputValues:e}))?(this.helpers?.setHiddenInputValue("formSubmitted","true"),this.formEl?.querySelector("shreddit-slotter")?.dispatchEvent(a("shreddit-slotter-set-slot-name",{slotName:"formSubmitted"}))):this.dispatchEvent(a("faceplate-alert",{level:n.error,cause:"uncategorized",message:"An error occurred while submitting your report. Wait a bit, and try again."}))}},this.initTemplatedUrlListener=()=>{const{action:t}=this.config;if(t&&"openTemplatedUrl"===t.actionType){const e=t.args;if(e){const s=e?.placeholders;s?.forEach((s=>{const i=e[s]?.ref;i&&this.formEl?.querySelector(`input[type=hidden][name="${i}"]`)?.addEventListener("change",(()=>{const e=this.helpers?.performAction(t);e?.href&&(this.href=e.href)}))}))}}},this.initEventListeners=()=>{const{text:t,disabled:e}=this.config;if(!this.helpers?.isString(t)){const e=this.helpers?.getTextDataRef(t);e&&this.formEl?.querySelector(`input[type=hidden][name="${e}"]`)?.addEventListener("change",(()=>{this.buttonText=this.helpers?.getText(this.config.text)??this.buttonText}))}if(e){const t=this.helpers?.getDisabledRef(e);t&&t.length&&t.forEach((t=>this.formEl?.querySelector(`input[type=hidden][name="${t}"]`)?.addEventListener("change",(async()=>{this.isDisabled=(this.config.disabled&&this.helpers?.getDisabledCondition(this.config.disabled))??this.isDisabled,await this.updateComplete,this.getRootNode()?.host?.getRootNode()?.host?.getModal().focusManager.refresh()}))))}else this.isDisabled=!1;this.initTemplatedUrlListener()}}firstUpdated(){this.initEventListeners()}connectedCallback(){super.connectedCallback();const t=this.getRootNode().host.closest("report-form");this.formEl=t,this.helpers=new c(t),this.gqlHelpers=new C(this.isEmbed),this.buttonText=this.helpers?.getText(this.config.text)??this.buttonText,this.config.disabled?this.isDisabled=this.helpers?.getDisabledCondition(this.config.disabled)??this.isDisabled:this.isDisabled=!1}render(){const t=this.href?{href:this.href,target:"_blank",rel:"noopener noreferrer"}:{};return f` ${l({appearance:"primary",attributes:{disabled:this.isDisabled,onclick:this.onButtonClick,className:"w-full s:w-auto relative",...t},children:f` <faceplate-progress value="20" class="animate-spin loading-icon hidden absolute left-0 right-0 m-auto w-[16px]" style="--loader-size:1rem"></faceplate-progress> <span class="report-button-content">${this.buttonText}</span>`})} `}};E.styles=[s],i([r({type:Object})],E.prototype,"config",void 0),i([r({type:Boolean,attribute:"is-embed"})],E.prototype,"isEmbed",void 0),i([r({type:String,attribute:"permalink"})],E.prototype,"permalink",void 0),i([r({type:String,attribute:"country-code"})],E.prototype,"countryCode",void 0),i([o()],E.prototype,"buttonText",void 0),i([o()],E.prototype,"isDisabled",void 0),i([o()],E.prototype,"href",void 0),E=i([d("report-action")],E);const k=[{hiddenInputRef:"value",inputAttribute:"value"},{hiddenInputRef:"nextAction",inputAttribute:"data-nextaction"},{hiddenInputRef:"label",inputAttribute:"data-label"},{hiddenInputRef:"description",inputAttribute:"data-description"}];let T=class extends g{firstUpdated(){this.updateComplete.then((()=>{this.dispatchEvent(a("report-form-rendered"))}))}constructor(){super(),this.reasonSelectionCache={},this.getSlotter=()=>this.querySelector("shreddit-slotter")?.shadowRoot,this.getSelectedReason=()=>this.getSlotter()?.querySelector("[data-buttonbar] button.button-activated"),this.getHiddenInput=t=>this.querySelector("form")?.querySelector(`input[type=hidden][name="${t}"]`),this.getFormElementById=t=>this.getSlotter()?.querySelector(`#${t}`),this.setHiddenInputValue=(t,e)=>{const s=this.getHiddenInput(t);s?.setAttribute("value",e??""),s?.dispatchEvent(new Event("change"))},this.getPreviousValue=t=>{if(t===p){const e=this.getHiddenInput(u)?.getAttribute("value")??"",s=this.reasonSelectionCache[e];this.setHiddenInputValue(t,s)}return this.getHiddenInput(t)?.getAttribute("value")},this.populateValue=async({fieldName:t,el:e,elType:s})=>{if(t){const i=this.getPreviousValue(t);if(i||""===i)switch(s){case"button":e.getAttribute("value")===i&&this.toggleReportReason(e);break;case"textDisplay":e.textContent=i,await this.updateComplete,this.helpers?.bottomScrollIntoViewIfNeeded(this.getSelectedReason());break;case"radioInput":e.getAttribute("value")===i&&e.setAttribute("checked","true");break;default:e.setAttribute("value",i)}}},this.toggleReportReason=t=>{const e=this.getSelectedReason();e&&(e.classList.remove("button-activated"),e.ariaChecked=null,e.removeAttribute("aria-describedby")),t.classList.add("button-activated"),t.ariaChecked="true",t.setAttribute("aria-describedby","report-footer-content-body")},this.updateHiddenInputsFromReportReason=t=>{const e=t.getAttribute("data-ref");k.forEach((({hiddenInputRef:s,inputAttribute:i})=>{this.setHiddenInputValue(`${e}.${s}`,t.getAttribute(i))}))},this.updateReasonSelectionCache=t=>{const e=this.getHiddenInput(u)?.getAttribute("value")??"";this.reasonSelectionCache={...this.reasonSelectionCache,[e]:t}},this.addReportReasonListeners=()=>{const t=this.getSlotter()?.querySelectorAll("[data-buttonbar] button");t?.length&&t.forEach((t=>{const e=t.getAttribute("data-ref");this.populateValue({fieldName:`${e}.value`,el:t,elType:"button"}),t.addEventListener("click",(t=>{t.stopImmediatePropagation(),t.currentTarget instanceof Element&&(this.toggleReportReason(t.currentTarget),this.updateHiddenInputsFromReportReason(t.currentTarget))}))}))},this.createTextWithLinkElement=t=>t.map((t=>"Link"===t.type?f`${m({children:t.text,attributes:{href:t.linkTo,target:"_blank",rel:"noopener noreferrer"}})}  `:f`<span>${t.text}</span> `)),this.showCurrentDynamicLinkElements=(t,e)=>{const s=JSON.parse(t);this.createTextWithLinkElement(s).forEach((t=>{const s=document.createElement("div");y(t,s),e.appendChild(s.firstElementChild)}))},this.addFooterListener=(t,e)=>{const s=this.getFormElementById(t),i=s?.getAttribute(e);s&&i&&(this.populateValue({fieldName:s.getAttribute(e),el:s,elType:"textDisplay"}),this.getHiddenInput(i)?.addEventListener("change",(async t=>{t.currentTarget instanceof Element&&(this.setFooterContent(s,t.currentTarget),await this.updateComplete,this.helpers?.bottomScrollIntoViewIfNeeded(this.getSelectedReason()))})))},this.setFooterContent=(t,e)=>{t.firstChild&&(t.innerHTML="");const s=e.getAttribute("value");s?.includes("PlainText")?this.showCurrentDynamicLinkElements(s,t):t.textContent=e.getAttribute("value")??""},this.addReasonFooterContentListeners=()=>{this.addFooterListener("report-footer-content-title","data-title-ref"),this.addFooterListener("report-footer-content-body","data-text-ref")},this.addRadioListeners=()=>{const t=this.getSlotter()?.querySelectorAll("faceplate-radio-input");t?.length&&t?.forEach((t=>{this.populateValue({fieldName:`${t.getAttribute("name")}.value`,el:t,elType:"radioInput"}),t.addEventListener("input",(t=>{if(t.currentTarget instanceof Element){const e=t.currentTarget.getAttribute("name"),s=t.currentTarget.getAttribute("value");this.setHiddenInputValue(`${e}.value`,s),this.updateReasonSelectionCache(s??"")}}))}))},this.showTextInput=t=>{t.classList.remove("hidden"),this.querySelector("shreddit-slotter")?.shadowRoot?.querySelector('faceplate-radio-input[name="subredditRule"][value="other"]')?.scrollIntoView()},this.addTextInputListeners=()=>{const t=this.getSlotter()?.querySelectorAll("faceplate-textarea-input");t?.length&&t.forEach((t=>{const e=t.getAttribute("data-visibility-ref"),s=t.getAttribute("data-visibility-check");this.populateValue({fieldName:t.name,el:t,elType:"textInput"});if(e&&s){const i=this.getHiddenInput(e);i?.getAttribute("value")===s&&this.showTextInput(t),i?.addEventListener("change",(e=>{e.currentTarget.getAttribute("value")===s?this.showTextInput(t):t.classList.contains("hidden")||t.classList.add("hidden")}))}t.shadowRoot?.querySelector("textarea")?.addEventListener("keyup",(t=>{const e=t.currentTarget.getAttribute("name"),s=t.currentTarget.value;e&&s&&this.setHiddenInputValue(e,s)}))}))},this.addUserBlockingSwitchListener=()=>{const t=this.getSlotter()?.querySelector("faceplate-switch-input");t&&t.addEventListener("click",(()=>{const e=t.checked;this.dispatchEvent(a("report-flow-blocking",{checked:e}))}))},this.addInteractionListeners=()=>{this.addReportReasonListeners(),this.addReasonFooterContentListeners(),this.addRadioListeners(),this.addTextInputListeners(),this.addUserBlockingSwitchListener()},this.addStepChangeListener=()=>{const t=this.querySelector("shreddit-slotter");t?.addEventListener("shreddit-slotter-set-slot-name",(async()=>{await t.updateComplete,this.addInteractionListeners()}))},this.initEventListeners=t=>{"report/view/reportform"===t.SAN&&(this.addInteractionListeners(),this.addStepChangeListener())},this.helpers=new c(this),this.addEventListener("faceplate-track",this.initEventListeners)}render(){return f` <slot></slot>`}};T.styles=[b`:host{display:block;width:100%}`,s],i([r({type:String,attribute:"author-id"})],T.prototype,"authorId",void 0),T=i([d("report-form")],T);let w=class extends g{static get styles(){return[b`:host>faceplate-banner{display:flex;flex-direction:column;gap:var(--spacer-md);align-items:center;position:fixed;left:50%;transform:translateX(-50%);padding:0 1rem;bottom:var(--rem16);width:calc(100% - 2rem)}`,s]}disconnectedCallback(){super.disconnectedCallback()}connectedCallback(){super.connectedCallback(),this.showError&&(this.dispatchAlert({}),this.dispatchCloseReportFlowEvent())}constructor(){super(),this.isEmbed=!1,this.thingId="",this.isOpen=!1,this.showError=!1,this.authorId="",this.authorName="",this.partialSrc="/svc/shreddit/report-flow/",this.getModal=()=>this.isDesktop?this.querySelector("faceplate-modal"):this.querySelector("faceplate-bottom-sheet"),this.initModalCloseListener=()=>{this.getModal()?.querySelector("#report-modal-close")?.addEventListener("click",this.onCloseModal)},this.dispatchCloseReportFlowEvent=()=>{this.dispatchEvent(a("report-flow-close"))},this.closeFramedModal=()=>{this.isEmbed&&parent.postMessage(JSON.stringify({type:"close.framedmodal"}),"*")},this.onCloseModal=t=>{if(t){const{buttonAction:e}=t.detail;this.isUserBlockedSwitchChecked&&"formClose"===e&&this.handleUserBlocking()}this.getModal()?.close(),this.dispatchCloseReportFlowEvent(),this.closeFramedModal()},this.addBaseSlotterListener=()=>{const t=this.getModal()?.querySelector("shreddit-slotter");t?.addEventListener("shreddit-slotter-set-slot-name",(async()=>{await t.updateComplete,this.getModal()?.focusManager.refresh(),this.getModal()?.focusManager.focusFirst()}))},this.initFlowSlotterListener=()=>{this.addEventListener("shreddit-slotter-set-slot-name",(()=>{this.renderBackButton(),this.updateModalTitle()}))},this.initModal=()=>{this.initFlowSlotterListener(),this.getModal()?.showModal(),this.initModalCloseListener(),this.initEscapeListener(),this.initModalBackButtonListener(),this.addBaseSlotterListener(),this.isEmbed&&parent.postMessage(JSON.stringify({type:"loaded.framedmodal"}),"*")},this.getInputValue=t=>this.getModal()?.querySelector("report-form")?.querySelector(`form input[type=hidden][name="${t}"]`)?.getAttribute("value"),this.setInputValue=(t,e)=>this.getModal()?.querySelector("report-form")?.querySelector(`form input[type=hidden][name="${t}"]`)?.setAttribute("value",e),this.onBackButtonClick=()=>{const t=this.getInputValue("screenSequence").split(","),e=t.slice(0,t.length);e.pop(),this.setInputValue("screenSequence",e.toString());const s=a("shreddit-slotter-set-slot-name",{slotName:e[e.length-1]});this.querySelector("shreddit-slotter").dispatchEvent(s)},this.renderBackButton=()=>{const t=this.getModal()?.querySelector("#report-modal-back");if(t){const e=this.getInputValue("formSubmitted");this.getInputValue("screenSequence").split(",").length>1&&"false"===e?(t?.classList.remove("hidden"),t.disabled=!1):(t?.classList.add("hidden"),t.disabled=!0)}},this.updateModalTitle=async()=>{await this.updateComplete;"true"===this.getInputValue("formSubmitted")&&(this.getModal()?.querySelector(".header-title")?.classList.add("hidden"),this.getModal()?.querySelector(".report-success-title")?.classList.remove("hidden"))},this.initModalBackButtonListener=()=>{this.getModal()?.querySelector("#report-modal-back")?.addEventListener("click",this.onBackButtonClick)},this.initEscapeListener=()=>{document.addEventListener("keydown",(t=>{if("Escape"===t.key){const t=this.getModal(),e=this.getCTLModal();""===t?.getAttribute("open")&&this.onCloseModal(),""===e?.getAttribute("open")&&this.onCloseCTLModal()}}))},this.handleUserBlocking=async()=>{try{await e({operation:t.UpdateRedditorBlockState,variables:{input:{redditorId:this.authorId,blockState:h.Blocked}}}),this.dispatchAlert({level:n.success,message:`u/${this.authorName} is now blocked.`})}catch(t){this.dispatchAlert({level:n.error,message:"An error has occured. Please try again later"})}},this.dispatchAlert=({level:t=n.error,message:e="Reporting is currently unavailable. Try reloading the page or waiting a few minutes, before trying again."})=>{this.dispatchEvent(a("faceplate-alert",{level:t,message:e}))},this.onCloseCTLModal=()=>{this.getCTLModal()?.close(),this.dispatchCloseReportFlowEvent(),this.closeFramedModal()},this.addCTLSlotterListener=()=>{const t=this.getCTLModal()?.querySelector("shreddit-slotter");t?.addEventListener("shreddit-slotter-set-slot-name",(async()=>{await t.updateComplete,this.getCTLModal()?.focusManager.refresh(),this.getCTLModal()?.focusManager.focusFirst();const e=this.getCTLModal()?.querySelector("shreddit-slotter")?.shadowRoot?.querySelector("#ctl-ok-button");e?.addEventListener("click",this.onCloseCTLModal)}))},this.getCTLModal=()=>this.querySelector("#ctl-modal"),this.initCTLModalCloseListener=()=>{this.getCTLModal()?.querySelector("#ctl-modal-close")?.addEventListener("click",this.onCloseCTLModal)},this.initCTLModal=async()=>{this.getModal()?.close(),this.getCTLModal()?.showModal(),this.initCTLModalCloseListener()},this.showThankYou=()=>{const t=a("shreddit-slotter-set-slot-name",{slotName:"thankyou"});this.getCTLModal()?.querySelector("shreddit-slotter")?.dispatchEvent(t)},this.submitCTLReport=async()=>{const t=this.helpers?.getHiddenInputValue("userDetail.value");await(this.gqlHelpers?.onCTLReportSubmit(this.thingId,t))?this.showThankYou():this.dispatchAlert({level:n.error,message:"An error occurred while submitting your report. Wait a bit, and try again."})},this.initCTLListeners=t=>{if("report/view/ctl"===t.SAN){const t=this.getCTLModal()?.querySelector("shreddit-slotter")?.shadowRoot?.querySelector("#ctl-yes-button");t?.addEventListener("click",this.submitCTLReport),this.getCTLModal()?.focusManager.refresh(),this.getCTLModal()?.focusManager.focusFirst(),this.addCTLSlotterListener()}},this.gqlHelpers=new C(this.isEmbed);const s=this.querySelector("report-form");s&&(this.helpers=new c(s)),this.addEventListener("report-form-rendered",this.initModal),this.addEventListener("faceplate-track",this.initCTLListeners),this.addEventListener("close-report-modal",this.onCloseModal),this.addEventListener("open-ctl-modal",this.initCTLModal),this.addEventListener("report-flow-blocking",(t=>{const{checked:e}=t.detail;this.isUserBlockedSwitchChecked=e}))}render(){return f`<slot></slot>`}};i([r({type:Boolean,attribute:"is-desktop"})],w.prototype,"isDesktop",void 0),i([r({type:Boolean,attribute:"is-embed"})],w.prototype,"isEmbed",void 0),i([r({type:String,attribute:"thing-id"})],w.prototype,"thingId",void 0),i([r({type:Boolean,attribute:"is-open"})],w.prototype,"isOpen",void 0),i([r({type:Boolean,attribute:"show-error"})],w.prototype,"showError",void 0),i([r({type:String,attribute:"author-id"})],w.prototype,"authorId",void 0),i([r({type:String,attribute:"author-name"})],w.prototype,"authorName",void 0),w=i([d("report-flow")],w);
